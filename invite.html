<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="inviteTitle">KKR Credit | Convidar</title>
    <!-- Favicon -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <!-- Google Fonts - Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome para ícones (CDN) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- CSS EMBUTIDO AQUI -->
    <style>
        /* Variáveis CSS (Consistente) */
        :root {
            --primary-purple: #6a0dad;
            --light-purple: #9b59b6;
            --hover-purple: #8e44ad;
            --dark-background: #2c3e50;
            --text-dark: #333;
            --text-medium: #666;
            --text-light: #555;
            --border-light: #e0e0e0;
            --white: #ffffff;
            --card-bg-light: #f7faff;
            --success-green: #2ecc71;
            --error-red: #e74c3c;
            --app-background: #e0e6ec;
            --info-blue: #3498db;
            --accent-orange: #f39c12; /* Cor de destaque para bônus/alerta */
        }

        /* Base e Estrutura */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; line-height: 1.6; color: var(--text-dark); background-color: var(--app-background); min-height: 100vh; display: flex; flex-direction: column; }
        .page-wrapper { max-width: 480px; width: 100%; margin: 0 auto; background-color: var(--card-bg-light); min-height: 100vh; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        /* Header (Consistente) */
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: var(--white); border-bottom: 1px solid var(--border-light); position: sticky; top: 0; z-index: 100; }
        .app-header .logo { font-size: 1.5em; font-weight: 700; color: var(--primary-purple); }
        .back-button { background: none; border: none; color: var(--text-medium); font-size: 1.2em; cursor: pointer; transition: color 0.2s ease; padding: 5px; }
        .back-button:hover { color: var(--primary-purple); }
        
        /* Main Content */
        .main-content { flex-grow: 1; padding: 20px; padding-bottom: 20px; overflow-y: auto; }
        .page-title { font-size: 1.8em; color: var(--primary-purple); font-weight: 700; margin-bottom: 25px; text-align: center; }

        /* Card de Convite Principal */
        .invite-card {
            background-color: var(--dark-background);
            border-radius: 15px;
            padding: 30px 20px;
            color: var(--white);
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        /* Título do Card */
        .invite-card h2 {
            font-size: 1.6em;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--success-green);
        }

        /* Área do Código de Referência */
        .referral-area {
            margin: 20px auto;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 10px;
        }
        .referral-area p {
            font-size: 1em;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
        }
        .referral-code {
            font-size: 2em;
            font-weight: 800;
            letter-spacing: 2px;
            color: var(--white);
            display: block;
        }

        /* Botões de Ação */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        .action-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .copy-btn {
            background-color: var(--accent-orange);
            color: var(--white);
        }
        .copy-btn:hover {
            background-color: #e67e22;
        }
        .share-btn {
            background-color: var(--info-blue);
            color: var(--white);
        }
        .share-btn:hover {
            background-color: #2980b9;
        }

        /* Seção de Regras/Benefícios */
        .benefits-section {
            background-color: var(--white);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .benefits-section h3 {
            font-size: 1.2em;
            color: var(--primary-purple);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border-light);
            padding-bottom: 5px;
        }
        .benefit-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            gap: 10px;
        }
        .benefit-item i {
            color: var(--success-green);
            font-size: 1.2em;
            margin-top: 2px;
        }
        .benefit-item p {
            font-size: 0.9em;
            color: var(--text-dark);
            text-align: left;
        }
        
        /* Mensagens - REMOVIDAS DO FLUXO PRINCIPAL */
        .loading-spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: var(--primary-purple); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .message { padding: 15px; border-radius: 5px; margin-bottom: 15px; font-weight: 500; text-align: center; }
        .success-message { color: var(--success-green); border: 1px solid var(--success-green); background-color: rgba(46, 204, 113, 0.1); }
        .error-message { color: var(--error-red); border: 1px solid var(--error-red); background-color: rgba(231, 76, 60, 0.1); }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <!-- Header -->
        <header class="app-header">
            <button class="back-button" onclick="navigateTo('home');" data-translate-key="backButtonAlt">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="logo">KKR Credit</div>
            <div></div> 
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <h1 class="page-title" data-translate-key="inviteHeader">Convidar e Ganhar</h1>

            <!-- Card Principal de Convite -->
            <section class="invite-card">
                <h2 data-translate-key="inviteCardTitle">Seja um Embaixador KKR!</h2>
                <p data-translate-key="inviteCardSubtitle">Convide amigos e ganhe uma comissão sobre os lucros deles.</p>

                <div class="referral-area">
                    <p data-translate-key="yourCode">Seu Código de Convite:</p>
                    <!-- O código é preenchido aqui. O spinner só aparece antes -->
                    <span class="referral-code" id="referralCodeDisplay">...</span>
                </div>

                <div class="action-buttons">
                    <button class="copy-btn" onclick="copyReferralCode()" data-translate-key="copyButton" id="copyButton">
                        <i class="fas fa-copy"></i> Copiar Código
                    </button>
                    <button class="share-btn" onclick="shareLink()" data-translate-key="shareButton" id="shareButton">
                        <i class="fas fa-share-alt"></i> Partilhar Link
                    </button>
                </div>
            </section>
            
            <!-- Mensagens de Feedback (Retângulos) - Removidos do fluxo principal -->
            <p id="feedbackMessage" class="message hidden"></p>
            <p id="loadingMessage" class="loading-spinner"></p> 

            <!-- Seção de Regras/Benefícios (COM DADOS REAIS DO ADMIN) -->
            <section class="benefits-section">
                <h3 data-translate-key="benefitsHeader">Como Funciona o Bônus de Indicação</h3>

                <div id="benefitsContent">
                    <!-- O conteúdo real será injetado aqui -->
                </div>
                
                <!-- A nota de rodapé removida conforme solicitado -->
                <!-- <p id="adminConfigNote" style="text-align: center; font-size: 0.8em; color: var(--text-medium); margin-top: 15px;"></p> -->
            </section>


        </main> <!-- Fim do main-content -->
    </div> <!-- Fim do page-wrapper -->

    <!-- Script para lógica do Convite EMBUTIDO AQUI -->
    <script>
        const BACKEND_URL = 'https://backend-cjl7.onrender.com';
        
        // --- Variáveis Globais ---
        let currentLang = 'pt';
        const APP_LINK = window.location.origin + '/register.html?ref=';
        let adminConfig = {}; // Para armazenar as configurações de bônus

        // Objeto de traduções (com placeholders {X}, {Y}, {Z}, {T})
        const translations = {
            en: {
                inviteTitle: 'KKR Credit | Invite', backButtonAlt: 'Back', inviteHeader: 'Invite and Earn', 
                inviteCardTitle: 'Be a KKR Ambassador!', inviteCardSubtitle: 'Invite friends and earn commission on their profits.',
                yourCode: 'Your Invitation Code:', copyButton: 'Copy Code', shareButton: 'Share Link',
                benefitsHeader: 'How the Referral Bonus Works',
                benefit1: '<strong>Activation Bonus:</strong> Earn {X}% of the initial amount invested by your friend.',
                benefit2: '<strong>Daily Commission:</strong> Receive {Y}% of the daily profit generated by your friend\'s investments, credited to your Bonus Balance.',
                benefit3: '<strong>Referral Goal:</strong> By referring {Z} active investors, you earn a fixed bonus of {T} MT.',
                loadingMessage: 'Loading invitation code...', copySuccess: 'Code Copied!', shareDefaultText: 'Join KKR Credit with my invitation code: {code}. Invest and earn daily profits! Link: {link}',
                networkError: 'A network error occurred. Check your connection or try again later.', sessionExpired: 'Session expired or unauthorized. Please log in again.',
            },
            pt: {
                inviteTitle: 'KKR Credit | Convidar', backButtonAlt: 'Voltar', inviteHeader: 'Convidar e Ganhar', 
                inviteCardTitle: 'Seja um Embaixador KKR!', inviteCardSubtitle: 'Convide amigos e ganhe uma comissão sobre os lucros deles.',
                yourCode: 'Seu Código de Convite:', copyButton: 'Copiar Código', shareButton: 'Partilhar Link',
                benefitsHeader: 'Como Funciona o Bônus de Indicação',
                benefit1: '<strong>Bônus de Ativação:</strong> Ganhe {X}% do valor inicial investido pelo seu amigo.',
                benefit2: '<strong>Comissão Diária:</strong> Receba {Y}% do lucro diário gerado pelos investimentos do seu amigo, creditado no seu Saldo Bônus.',
                benefit3: '<strong>Meta de Referidos:</strong> Ao indicar {Z} investidores ativos, você ganha um bônus fixo de {T} MT.',
                loadingMessage: 'Carregando código de convite...', copySuccess: 'Código Copiado!', shareDefaultText: 'Junte-se à KKR Credit com o meu código de convite: {code}. Invista e ganhe lucros diários! Link: {link}',
                networkError: 'Ocorreu um erro de rede. Verifique sua conexão ou tente novamente mais tarde.', sessionExpired: 'Sessão expirada ou não autorizada. Por favor, faça login novamente.',
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadLanguagePreference();
            applyTranslations(currentLang);
            fetchInitialData(); // Nova função para buscar tudo
        });

        // Expondo para o HTML
        window.navigateTo = navigateTo;
        window.copyReferralCode = copyReferralCode;
        window.shareLink = shareLink;


        // --- Funções Auxiliares (Padrão) ---
        function loadLanguagePreference() {
            const savedLang = localStorage.getItem('langPreference');
            if (savedLang) {
                const { lang } = JSON.parse(savedLang);
                currentLang = lang;
            }
        }

        function applyTranslations(lang) {
            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.dataset.translateKey;
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'TITLE') {
                        document.title = translations[lang][key];
                    } else if (element.tagName !== 'BUTTON' && element.tagName !== 'I') {
                         element.innerHTML = translations[lang][key]; // Usa innerHTML para permitir tags <strong>
                    }
                }
            });
        }

        function setActionMessage(message, type = 'error', hideAfter = 3000) {
            const messageElement = document.getElementById('feedbackMessage');
            if (messageElement) {
                messageElement.classList.remove('hidden', 'success-message', 'error-message');
                messageElement.textContent = message;
                messageElement.classList.add(`${type}-message`);
                
                if (hideAfter > 0) {
                     setTimeout(() => messageElement.classList.add('hidden'), hideAfter);
                }
            }
        }
        
        function navigateTo(page) {
            const pageMap = {
                'home': 'dashboard.html',
                'profile': 'profile.html',
                'invite': 'invite.html',
            };
            const targetPage = pageMap[page] || 'dashboard.html';
            window.location.href = targetPage;
        }

        // --- 1. Fetch de Dados Iniciais (Perfil e Config Admin) ---
        async function fetchInitialData() {
            const token = localStorage.getItem('token');
            const codeDisplay = document.getElementById('referralCodeDisplay');
            const loadingSpinner = document.getElementById('loadingMessage');
            const copyButton = document.getElementById('copyButton');
            const shareButton = document.getElementById('shareButton');
            
            if (!token) {
                setActionMessage(translations[currentLang].sessionExpired, 'error', 0);
                codeDisplay.textContent = 'ERRO';
                loadingSpinner.classList.add('hidden');
                copyButton.disabled = true;
                shareButton.disabled = true;
                setTimeout(() => window.location.href = 'login.html', 2000);
                return;
            }

            loadingSpinner.classList.remove('hidden');
            codeDisplay.textContent = '...';
            copyButton.disabled = true;
            shareButton.disabled = true;

            try {
                // 1. Busca Perfil (para o código de convite)
                const [profileResponse, configResponse] = await Promise.all([
                    fetch(`${BACKEND_URL}/api/profile`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`${BACKEND_URL}/api/deposit-config`) // Rota pública que retorna config Admin
                ]);

                if (profileResponse.status === 401 || profileResponse.status === 403 || !profileResponse.ok) {
                    throw new Error("sessionExpired");
                }
                
                const profileData = await profileResponse.json();
                const configData = await configResponse.json();
                
                // 2. Processa Perfil
                const code = profileData.user.referralCode;
                if (code) {
                    codeDisplay.textContent = code;
                    copyButton.disabled = false;
                    shareButton.disabled = false;
                } else {
                    codeDisplay.textContent = 'N/A';
                    // Nenhuma mensagem de erro persistente se for N/A, apenas no console
                }
                
                // 3. Processa Config Admin
                adminConfig = configData.config || {};
                renderBenefitsSection(adminConfig);

            } catch (error) {
                if (error.message.includes("sessionExpired")) {
                    setActionMessage(translations[currentLang].sessionExpired, 'error');
                    localStorage.removeItem('token');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                } else {
                    // Mensagem de erro apenas se o carregamento falhar
                    setActionMessage(`${translations[currentLang].networkError}: ${error.message}`, 'error', 0);
                    codeDisplay.textContent = 'ERRO';
                }
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        // --- 2. Renderiza a Seção de Benefícios com Dados Reais ---
        function renderBenefitsSection(config) {
            const container = document.getElementById('benefitsContent');
            const lang = currentLang;
            
            // CORREÇÃO CRÍTICA: Lida com valores nulos/undefined/NaN
            const getSafePercent = (value) => {
                const num = parseFloat(value);
                return (isNaN(num) || num === null || num === undefined) ? '0' : (num * 100).toFixed(0);
            };
            const getSafeAmount = (value) => {
                const num = parseFloat(value);
                return (isNaN(num) || num === null || num === undefined) ? '0.00' : num.toFixed(2);
            };
            const getSafeCount = (value) => {
                const num = parseInt(value);
                return (isNaN(num) || num === null || num === undefined) ? '0' : num;
            };


            const X = getSafePercent(config.commissionOnPlanActivation); // Bônus de Ativação
            const Y = getSafePercent(config.commissionOnDailyProfit);    // Comissão Diária
            const Z = getSafeCount(config.referralRequiredInvestedCount); // Qtd. de Referidos
            const T = getSafeAmount(config.referralBonusAmount);         // Bônus Fixo (MT)

            const benefit1Text = translations[lang].benefit1.replace('{X}', X);
            const benefit2Text = translations[lang].benefit2.replace('{Y}', Y);
            const benefit3Text = translations[lang].benefit3.replace('{Z}', Z).replace('{T}', T);
            
            container.innerHTML = `
                <div class="benefit-item">
                    <i class="fas fa-medal"></i>
                    <p>${benefit1Text}</p>
                </div>
                <div class="benefit-item">
                    <i class="fas fa-chart-line"></i>
                    <p>${benefit2Text}</p>
                </div>
                <div class="benefit-item">
                    <i class="fas fa-trophy"></i>
                    <p>${benefit3Text}</p>
                </div>
            `;
            
            // NOTA: A nota de rodapé foi removida conforme solicitado.
        }

        // --- 3. Funções de Cópia e Compartilhamento ---
        async function copyReferralCode() {
            const code = document.getElementById('referralCodeDisplay').textContent.trim();
            if (code === 'N/A' || code === '...' || code === 'ERRO') {
                setActionMessage('Aguarde o carregamento do código de convite.', 'error');
                return;
            }

            try {
                await navigator.clipboard.writeText(code);
                setActionMessage(translations[currentLang].copySuccess, 'success');
            } catch (err) {
                console.error('Falha ao copiar:', err);
                setActionMessage('Erro ao copiar. Copie manualmente.', 'error');
            }
        }
        
        async function shareLink() {
            const code = document.getElementById('referralCodeDisplay').textContent.trim();
            if (code === 'N/A' || code === '...' || code === 'ERRO') {
                setActionMessage('Aguarde o carregamento do código de convite.', 'error');
                return;
            }
            
            const link = APP_LINK + code;
            const shareText = translations[currentLang].shareDefaultText
                .replace('{code}', code)
                .replace('{link}', link);
            
            // Verifica se a API Web Share está disponível (para dispositivos móveis)
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: translations[currentLang].inviteCardTitle,
                        text: shareText,
                        url: link
                    });
                } catch (error) {
                    console.error('Erro ao compartilhar:', error);
                    fallbackShare(shareText); // Usa o método de fallback
                }
            } else {
                fallbackShare(shareText);
            }
        }

        function fallbackShare(shareText) {
            // Tenta copiar o texto para a área de transferência como fallback
            try {
                navigator.clipboard.writeText(shareText);
                setActionMessage('Link de convite e código copiados para a área de transferência!', 'success', 5000);
            } catch(e) {
                setActionMessage('Seu navegador não suporta compartilhamento automático. O código foi copiado manualmente.', 'error');
            }
        }
    </script>
</body>
</html>