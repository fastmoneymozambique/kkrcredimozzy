<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="incomeTitle">KKR Credit | Renda</title>
    <!-- Favicon -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <!-- Google Fonts - Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome para ícones (CDN) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- CSS EMBUTIDO AQUI -->
    <style>
        /* Variáveis CSS (Consistente com Dashboard/Pool) */
        :root {
            --primary-purple: #6a0dad;
            --light-purple: #9b59b6;
            --hover-purple: #8e44ad;
            --dark-background: #2c3e50;
            --text-dark: #333;
            --text-medium: #666;
            --text-light: #555;
            --border-light: #e0e0e0;
            --white: #ffffff;
            --card-bg-light: #f7faff;
            --success-green: #2ecc71; /* Para lucro/renda */
            --error-red: #e74c3c;
            --app-background: #e0e6ec;
            --info-blue: #3498db;
            --investment-orange: #ff9800; /* Cor para montante investido */
        }

        /* Reset e Base */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background-color: var(--app-background);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Container Principal */
        .page-wrapper {
            max-width: 480px;
            width: 100%;
            margin: 0 auto;
            background-color: var(--card-bg-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* Header (Consistente) */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--white);
            border-bottom: 1px solid var(--border-light);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .app-header .logo {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary-purple);
        }
        .back-button { background: none; border: none; color: var(--text-medium); font-size: 1.2em; cursor: pointer; transition: color 0.2s ease; padding: 5px; }
        .back-button:hover { color: var(--primary-purple); }

        /* Main Content */
        .main-content {
            flex-grow: 1;
            padding: 20px;
            padding-bottom: 80px;
            overflow-y: auto;
        }

        /* Título da Página */
        .page-title {
            font-size: 1.8em;
            color: var(--primary-purple);
            font-weight: 700;
            margin-bottom: 25px;
            text-align: center;
        }
        
        /* Card de Resumo de Renda */
        .income-summary-card {
            background-color: var(--dark-background);
            border-radius: 15px;
            padding: 20px;
            color: var(--white);
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .summary-title {
            font-size: 1em;
            color: rgba(255,255,255,0.7);
            margin-bottom: 5px;
        }
        .summary-value {
            font-size: 2.2em;
            font-weight: 700;
            color: var(--success-green); /* Destaque em verde para o lucro total */
            margin-bottom: 15px;
        }
        .summary-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
        }
        .summary-item {
            text-align: center;
            padding: 10px;
            background-color: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        .summary-item .label {
            font-size: 0.8em;
            color: rgba(255,255,255,0.6);
        }
        .summary-item .value {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--white);
            margin-top: 2px;
        }

        /* Seção de Investimentos Ativos */
        .active-investments-section h2 {
            font-size: 1.4em;
            color: var(--text-dark);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--primary-purple);
            padding-bottom: 5px;
        }
        #activeInvestmentsList {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Card de Investimento Ativo */
        .investment-card {
            background-color: var(--white);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .investment-card h3 {
            font-size: 1.1em;
            color: var(--primary-purple);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .investment-card h3 .status {
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 15px;
            font-weight: 600;
            background-color: var(--success-green);
            color: var(--white);
        }
        .investment-detail {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-light);
            font-size: 0.9em;
        }
        .investment-detail .label {
            color: var(--text-medium);
            font-weight: 500;
        }
        .investment-detail .value {
            color: var(--text-dark);
            font-weight: 600;
        }
        .investment-detail .value.invested {
            color: var(--investment-orange);
        }
        .investment-detail .value.profit {
            color: var(--success-green);
        }

        /* Mensagens (Consistente com Pool) */
        .message {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
        }
        .loading-message {
            color: var(--primary-purple);
            border: 1px solid var(--light-purple);
            background-color: rgba(106, 13, 173, 0.1);
        }
        .info-message {
            color: var(--info-blue);
            border: 1px solid var(--info-blue);
            background-color: rgba(52, 152, 219, 0.1);
        }

        /* Botão de Navegação Inferior (Consistente) */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
            background-color: var(--white);
            border-top: 1px solid var(--border-light);
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 480px;
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-medium);
            font-size: 0.7em;
            cursor: pointer;
            transition: color 0.2s ease;
            padding: 5px 0;
            flex: 1;
        }
        .nav-item i {
            font-size: 1.3em;
            margin-bottom: 3px;
        }
        .nav-item.active {
            color: var(--primary-purple);
            font-weight: 600;
        }
        .nav-item:hover {
            color: var(--primary-purple);
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <!-- Header -->
        <header class="app-header">
            <button class="back-button" onclick="navigateTo('home');" data-translate-key="backButtonAlt">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="logo">KKR Credit</div>
            <div></div> <!-- Espaçador para alinhamento -->
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <h1 class="page-title" data-translate-key="incomeHeader">Renda de Investimentos</h1>

            <!-- Card de Resumo de Renda -->
            <section class="income-summary-card">
                <p class="summary-title" data-translate-key="totalProfitLabel">Lucro Total Acumulado</p>
                <p class="summary-value" id="totalProfitValue">0.00 MT</p>
                
                <div class="summary-info-grid">
                    <div class="summary-item">
                        <p class="label" data-translate-key="totalInvestedLabel">Total Investido</p>
                        <p class="value" id="totalInvestedValue">0.00 MT</p>
                    </div>
                    <div class="summary-item">
                        <p class="label" data-translate-key="todayProfitLabel">Lucro de Hoje</p>
                        <p class="value" id="todayProfitValue">0.00 MT</p>
                    </div>
                </div>
            </section>

            <!-- Seção de Investimentos Ativos -->
            <section class="active-investments-section">
                <h2 data-translate-key="activeInvestmentsHeader">Meus Pacotes Ativos</h2>
                
                <div id="activeInvestmentsList">
                    <p id="loadingMessage" class="message loading-message" data-translate-key="loadingInvestments">Carregando investimentos ativos...</p>
                    <!-- Os investimentos ativos serão injetados aqui -->
                </div>
            </section>

        </main> <!-- Fim do main-content -->

        <!-- Bottom Navigation Bar -->
        <nav class="bottom-nav">
            <div class="nav-item" onclick="navigateTo('home');">
                <i class="fas fa-home"></i>
                <span data-translate-key="navHome">Home</span>
            </div>
            <div class="nav-item" onclick="navigateTo('pool');">
                <i class="fas fa-coins"></i>
                <span data-translate-key="navPool">Pacotes</span>
            </div>
            <div class="nav-item active" onclick="navigateTo('income');">
                <i class="fas fa-chart-line"></i>
                <span data-translate-key="navIncome">Renda</span>
            </div>
            <div class="nav-item" onclick="navigateTo('wallet');">
                <i class="fas fa-wallet"></i>
                <span data-translate-key="navWallet">Carteira</span>
            </div>
            <div class="nav-item" onclick="navigateTo('profile');">
                <i class="fas fa-user"></i>
                <span data-translate-key="navProfile">Perfil</span>
            </div>
        </nav>

    </div> <!-- Fim do page-wrapper -->

    <!-- Script para lógica de Renda EMBUTIDO AQUI -->
    <script>
        const BACKEND_URL = 'https://backend-cjl7.onrender.com';

        // Objeto de traduções (TERMINOLOGIA ATUALIZADA)
        const translations = {
            en: {
                incomeTitle: 'KKR Credit | Income',
                backButtonAlt: 'Back',
                incomeHeader: 'Investment Income',
                totalProfitLabel: 'Total Accumulated Profit',
                totalInvestedLabel: 'Total Invested',
                todayProfitLabel: 'Today\'s Profit',
                activeInvestmentsHeader: 'My Active Packages',
                loadingInvestments: 'Loading active investments...',
                noActiveInvestments: 'No active investment packages found. Start investing in the Pacotes page!',
                investmentName: 'Package Name',
                investedAmount: 'Invested Amount',
                currentProfit: 'Accumulated Profit',
                dailyRate: 'Daily Rate',
                endDate: 'End Date',
                statusActive: 'Active',
                statusCompleted: 'Completed',
                statusCancelled: 'Cancelled',
                networkError: 'A network error occurred. Check your connection or try again later.',
                sessionExpired: 'Session expired or unauthorized. Please log in again.',
                navHome: 'Home', navPool: 'Pacotes', navIncome: 'Income', navWallet: 'Wallet', navProfile: 'Profile',
            },
            pt: {
                incomeTitle: 'KKR Credit | Renda',
                backButtonAlt: 'Voltar',
                incomeHeader: 'Renda de Investimentos',
                totalProfitLabel: 'Lucro Total Acumulado',
                totalInvestedLabel: 'Total Investido',
                todayProfitLabel: 'Lucro de Hoje',
                activeInvestmentsHeader: 'Meus Pacotes Ativos',
                loadingInvestments: 'Carregando investimentos ativos...',
                noActiveInvestments: 'Nenhum pacote de investimento ativo encontrado. Comece a investir na página Pacotes!',
                investmentName: 'Nome do Pacote',
                investedAmount: 'Valor Investido',
                currentProfit: 'Lucro Acumulado',
                dailyRate: 'Taxa Diária',
                endDate: 'Data de Término',
                statusActive: 'Ativo',
                statusCompleted: 'Completo',
                statusCancelled: 'Cancelado',
                networkError: 'Ocorreu um erro de rede. Verifique sua conexão ou tente novamente mais tarde.',
                sessionExpired: 'Sessão expirada ou não autorizada. Por favor, faça login novamente.',
                navHome: 'Home', navPool: 'Pacotes', navIncome: 'Renda', navWallet: 'Carteira', navProfile: 'Perfil',
            }
        };

        let currentLang = 'pt';

        document.addEventListener('DOMContentLoaded', () => {
            loadLanguagePreference();
            applyTranslations(currentLang);
            fetchActiveInvestments();
        });

        // --- Funções Auxiliares de UI e Navegação (Consistente) ---
        function setActionMessage(id, message, type = 'error') {
            const messageElement = document.getElementById(id);
            if (messageElement) {
                messageElement.classList.remove('hidden', 'loading-message', 'info-message');
                messageElement.textContent = message;
                messageElement.classList.add(`${type}-message`);
            }
        }
        
        function loadLanguagePreference() {
            const savedLang = localStorage.getItem('langPreference');
            if (savedLang) {
                const { lang } = JSON.parse(savedLang);
                currentLang = lang;
            }
        }

        function applyTranslations(lang) {
            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.dataset.translateKey;
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'TITLE') {
                        document.title = translations[lang][key];
                    } else if (element.tagName !== 'BUTTON' && element.tagName !== 'I') {
                        element.textContent = translations[lang][key];
                    }
                }
            });
        }

        function navigateTo(page) {
            const pageMap = {
                'home': 'dashboard.html',
                'pool': 'pool.html',
                'income': 'income.html',
                'wallet': 'wallet.html',
                'profile': 'profile.html',
            };
            const targetPage = pageMap[page];
            if (targetPage) {
                window.location.href = targetPage;
            }
        }
        
        // --- Função Principal: Busca Investimentos Ativos ---
        async function fetchActiveInvestments() {
            const token = localStorage.getItem('token');
            const listContainer = document.getElementById('activeInvestmentsList');
            const loadingMessage = document.getElementById('loadingMessage');
            
            if (!token) {
                loadingMessage.textContent = translations[currentLang].sessionExpired;
                setTimeout(() => window.location.href = 'login.html', 2000);
                return;
            }

            loadingMessage.classList.remove('hidden');
            listContainer.innerHTML = ''; // Limpa a lista antes de carregar

            try {
                const response = await fetch(`${BACKEND_URL}/api/investments/active`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.status === 401 || response.status === 403) {
                    throw new Error("sessionExpired");
                }
                
                if (!response.ok) {
                    throw new Error(`Status ${response.status}`);
                }

                const data = await response.json();
                
                // 1. Calcular Totais para o Card de Resumo
                let totalInvested = 0;
                let totalAccumulatedProfit = 0;
                let todayProfit = 0; // O cálculo de lucro de hoje é complexo no frontend e simplificado aqui
                                    // Mas no backend (processDailyProfitsAndCommissions) ele é exato.
                                    // Para o frontend, vamos estimar o lucro diário total para o resumo.
                
                // 2. Renderizar Investimentos
                if (data.investments && data.investments.length > 0) {
                    data.investments.forEach(inv => {
                        // Calcula totais
                        totalInvested += inv.investedAmount;
                        totalAccumulatedProfit += inv.currentProfit;
                        
                        // O lucro de hoje seria o investedAmount * dailyProfitRate (se a cron rodou)
                        todayProfit += (inv.investedAmount * inv.dailyProfitRate);

                        // Renderiza o Card Individual
                        const card = createInvestmentCard(inv);
                        listContainer.appendChild(card);
                    });
                } else {
                    // Sem investimentos ativos
                    listContainer.innerHTML = `<p class="message info-message">${translations[currentLang].noActiveInvestments}</p>`;
                }
                
                // 3. Atualizar o Card de Resumo
                document.getElementById('totalInvestedValue').textContent = totalInvested.toFixed(2) + ' MT';
                document.getElementById('totalProfitValue').textContent = totalAccumulatedProfit.toFixed(2) + ' MT';
                document.getElementById('todayProfitValue').textContent = todayProfit.toFixed(2) + ' MT'; // Usando a estimativa
                
            } catch (error) {
                if (error.message.includes("sessionExpired")) {
                    setActionMessage('loadingMessage', translations[currentLang].sessionExpired, 'error');
                    localStorage.removeItem('token');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                } else {
                    setActionMessage('loadingMessage', `${translations[currentLang].networkError}: ${error.message}`, 'error');
                    console.error("Erro ao buscar investimentos ativos:", error);
                }
            } finally {
                loadingMessage.classList.add('hidden');
            }
        }

        // --- Constrói o Card de Investimento Ativo ---
        function createInvestmentCard(inv) {
            const card = document.createElement('div');
            card.className = 'investment-card';
            
            // Determina nome do pacote e status traduzido
            const packageName = inv.planId ? inv.planId.name : 'Pacote Desconhecido';
            const statusText = inv.status === 'active' ? translations[currentLang].statusActive : 
                               inv.status === 'completed' ? translations[currentLang].statusCompleted : 
                               translations[currentLang].statusCancelled;

            // Formata a data de término
            const endDateFormatted = new Date(inv.endDate).toLocaleDateString(currentLang);

            card.innerHTML = `
                <h3>
                    <i class="fas fa-seedling"></i> ${packageName}
                    <span class="status">${statusText}</span>
                </h3>
                <div class="investment-detail">
                    <span class="label" data-translate-key="investedAmount">${translations[currentLang].investedAmount}</span>
                    <span class="value invested">${inv.investedAmount.toFixed(2)} MT</span>
                </div>
                <div class="investment-detail">
                    <span class="label" data-translate-key="currentProfit">${translations[currentLang].currentProfit}</span>
                    <span class="value profit">${inv.currentProfit.toFixed(2)} MT</span>
                </div>
                <div class="investment-detail">
                    <span class="label" data-translate-key="dailyRate">${translations[currentLang].dailyRate}</span>
                    <span class="value">${(inv.dailyProfitRate * 100).toFixed(2)}%</span>
                </div>
                <div class="investment-detail">
                    <span class="label" data-translate-key="endDate">${translations[currentLang].endDate}</span>
                    <span class="value">${endDateFormatted}</span>
                </div>
            `;
            return card;
        }
    </script>
</body>
</html>