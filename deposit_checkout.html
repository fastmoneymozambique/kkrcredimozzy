<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KKR Credit | Checkout</title>
    <!-- Favicon -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <!-- Google Fonts - Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome para ícones (CDN) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- CSS EMBUTIDO AQUI -->
    <style>
        /* Variáveis CSS (Consistente) */
        :root {
            --primary-purple: #6a0dad;
            --light-purple: #9b59b6;
            --hover-purple: #8e44ad;
            --dark-background: #2c3e50;
            --text-dark: #333;
            --white: #ffffff;
            --deposit-color: #007bff; 
            --error-red: #e74c3c;
            --success-green: #2ecc71;
            --app-background: #e0e6ec;
            --info-blue: #3498db;
        }

        /* Base e Estrutura */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Poppins', sans-serif; line-height: 1.6; color: var(--text-dark); background-color: var(--app-background); min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; padding: 20px 0; 
        }
        .checkout-container {
            background: var(--white); border-radius: 15px; padding: 30px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 0 25px rgba(0, 0, 0, 0.2); margin-top: 20px;
        }
        
        /* Cabeçalho do Checkout */
        .checkout-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--app-background);
        }
        .checkout-header h3 { 
            color: var(--deposit-color); margin-bottom: 5px; font-size: 1.5em; 
        }

        /* Timer */
        .modal-timer { 
            font-size: 1.8em; font-weight: 700; color: var(--error-red); margin-bottom: 20px; padding: 5px; border: 2px dashed var(--error-red); border-radius: 8px; display: inline-block;
        }

        /* Detalhes da Transferência */
        .deposit-details { margin-bottom: 25px; padding: 15px; background: var(--dark-background); border-radius: 10px; text-align: left; color: var(--white); }
        .deposit-details p { margin: 8px 0; font-size: 0.9em; }
        .deposit-details strong { color: var(--success-green); font-size: 1.2em; display: block; margin-top: 2px; }
        .copy-btn { margin-left: 10px; padding: 5px 10px; background-color: var(--primary-purple); color: var(--white); border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; font-size: 0.8em; }
        .copy-btn:hover { background-color: var(--hover-purple); }
        .copy-btn:disabled { background-color: var(--text-dark); }
        
        /* Formulário de Confirmação */
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--text-dark); font-weight: 500; }
        .input-group textarea { width: 100%; padding: 10px 15px; border: 1px solid var(--app-background); border-radius: 8px; font-size: 1em; resize: vertical; min-height: 80px; }
        .submit-btn { 
             width: 100%; padding: 12px; color: var(--white); border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease, transform 0.1s ease; margin-top: 10px;
             display: flex; align-items: center; justify-content: center;
        }
        .submit-btn.deposit { background-color: var(--deposit-color); }
        .submit-btn.deposit:hover { background-color: #0056b3; }
        .submit-btn.cancel { background-color: var(--error-red); margin-top: 10px; }
        .submit-btn.cancel:hover { background-color: #b3001e; }
        .submit-btn i { margin-right: 5px; }
        
        /* Mensagens de Erro em linha */
        .inline-error {
            color: var(--error-red);
            font-size: 0.85em;
            margin-top: 5px;
            display: block;
        }
        
        /* --- NOVO: Estilo para Modal de Sucesso --- */
        .success-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .success-modal.show {
            opacity: 1;
        }
        .modal-content-box {
            background-color: var(--white);
            border-radius: 15px;
            padding: 30px;
            width: 80%;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .success-modal.show .modal-content-box {
            transform: scale(1);
        }
        .success-icon {
            font-size: 4em;
            color: var(--success-green);
            margin-bottom: 15px;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.9); }
            50% { transform: scale(1); }
            100% { transform: scale(0.9); }
        }
        .modal-content-box h3 {
            color: var(--text-dark);
            margin-bottom: 10px;
        }
        .modal-content-box p {
            color: var(--text-medium);
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        .modal-content-box button {
            background-color: var(--success-green);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        /* --- FIM: Estilo para Modal de Sucesso --- */
        
        /* --- Estilo para Toast Notification --- */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            width: 90%;
            max-width: 400px;
            pointer-events: none; 
        }
        .toast {
            background-color: var(--white);
            color: var(--text-dark);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(-20px);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success { border-left: 5px solid var(--success-green); }
        .toast.error { border-left: 5px solid var(--error-red); }
        .toast.info { border-left: 5px solid var(--info-blue, #3498db); }
        .toast i { font-size: 1.2em; }
        .toast.success i { color: var(--success-green); }
        .toast.error i { color: var(--error-red); }
        .toast.info i { color: var(--info-blue, #3498db); }
        /* --- FIM: Estilo para Toast Notification --- */
        
        /* Estilo para animação de botão (Feedback de Sucesso e Erro) */
        .submit-btn.success-animate {
            background-color: var(--success-green) !important;
            transition: all 0.1s ease-in-out;
        }
        .submit-btn.error-animate {
            background-color: var(--error-red) !important;
            transition: all 0.1s ease-in-out;
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .hidden { display: none !important; }

    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container">
        <div id="appToast" class="toast hidden">
            <i class="fas fa-info-circle"></i>
            <span id="toastMessage">Mensagem</span>
        </div>
    </div>
    
    <!-- NOVO: Modal de Sucesso -->
    <div id="successModal" class="success-modal hidden">
        <div class="modal-content-box">
            <i class="fas fa-check-circle success-icon"></i>
            <h3 id="modalTitle">Depósito Solicitado!</h3>
            <p id="modalText">Sua solicitação de depósito foi enviada para aprovação do administrador.</p>
            <button onclick="closeSuccessModal()">Ver Histórico</button>
        </div>
    </div>
    <!-- FIM NOVO: Modal de Sucesso -->
    
    <div class="checkout-container">
        <div class="checkout-header">
            <h3 data-translate-key="checkoutTitle">Checkout de Depósito</h3>
            <p class="modal-timer" id="timerDisplay">05:00</p>
        </div>
        
        <p data-translate-key="checkoutInstruction">Transfira o valor de <strong id="checkoutAmount">...</strong> para a conta abaixo (<span id="checkoutMethod">...</span>) em até 5 minutos.</p>

        <div class="deposit-details">
            <p><span data-translate-key="modalRecipientNameLabel">Nome:</span> <strong><span id="checkoutRecipientName">Carregando...</span></strong></p>
            <p><span data-translate-key="modalPhoneNumberLabel">Número:</span> <strong><span id="checkoutPhoneNumber">Carregando...</span></strong> <button class="copy-btn fas fa-copy" onclick="copyToClipboard('checkoutPhoneNumber', this)"></button></p>
        </div>
        
        <form id="checkoutConfirmationForm">
            <div class="input-group">
                <label for="confirmationMessage" data-translate-key="confirmationLabel">Cole a Mensagem de Confirmação (SMS)</label>
                <textarea id="confirmationMessage" name="confirmationMessage" required></textarea>
                <span id="checkoutError" class="inline-error hidden"></span>
            </div>
            
            <button type="submit" class="submit-btn deposit" data-translate-key="modalConfirmButton">
                <i class="fas fa-check-circle"></i> Confirmar Transferência
            </button>
        </form>
        <button class="submit-btn cancel" onclick="cancelCheckout()" data-translate-key="modalCancelButton">
             <i class="fas fa-times-circle"></i> Cancelar
        </button>
    </div>

    <!-- Script para lógica do Checkout EMBUTIDO AQUI -->
    <script>
        const BACKEND_URL = 'https://backend-cjl7.onrender.com';
        const CHECKOUT_DURATION = 60 * 5; // 5 minutos em segundos
        let timerInterval;

        // Variável de estado para guardar a config real do Admin
        let DEPOSIT_CONFIG = {}; 

        // Objeto de traduções
        const translations = {
            pt: {
                checkoutTitle: 'Checkout de Depósito',
                checkoutInstruction: 'Transfira o valor de {amount} MT para a conta abaixo ({method}) em até 5 minutos.',
                modalRecipientNameLabel: 'Nome:',
                modalPhoneNumberLabel: 'Número:',
                confirmationLabel: 'Cole a Mensagem de Confirmação (SMS)',
                modalConfirmButton: 'Confirmar Transferência',
                modalCancelButton: 'Cancelar',
                depositSuccess: 'Solicitação de depósito enviada para aprovação.',
                timerExpired: 'Tempo expirado. Cancelado. Retornando para a Carteira.',
                requestFailed: 'Falha na solicitação:',
                networkError: 'Ocorreu um erro de rede. Verifique sua conexão ou tente novamente mais tarde.',
                sessionExpired: 'Sessão expirada ou não autorizada. Por favor, faça login novamente.',
                copySuccess: 'Copiado!',
                loadingConfig: 'Carregando configurações de depósito...',
                confirmationRequired: 'O comprovativo de confirmação é obrigatório (mín. 5 caracteres).',
                modalTitleDeposit: 'Depósito Solicitado',
                modalTextDeposit: 'Sua solicitação de depósito de {amount} MT foi enviada para aprovação. O saldo será atualizado após a verificação do administrador. Você pode acompanhar o status no histórico.',
            }
        };

        document.addEventListener('DOMContentLoaded', initializeCheckout);

        // --- Funções Auxiliares de UI/Animação/Toast/Modal ---
        
        /**
         * Exibe uma notificação Toast no topo da página.
         */
        function showToast(message, type = 'info') {
            const toastElement = document.getElementById('appToast');
            const toastMessage = document.getElementById('toastMessage');
            const icon = toastElement.querySelector('i');

            if (!toastElement || !toastMessage || !icon) return;

            toastElement.classList.remove('show', 'success', 'error', 'info');
            toastElement.classList.add('hidden');

            toastElement.className = 'toast show';
            icon.className = 'fas';
            
            if (type === 'success') {
                toastElement.classList.add('success');
                icon.classList.add('fa-check-circle');
            } else if (type === 'error') {
                toastElement.classList.add('error');
                icon.classList.add('fa-times-circle');
            } else {
                toastElement.classList.add('info');
                icon.classList.add('fa-info-circle');
            }

            toastMessage.textContent = message;
            toastElement.classList.remove('hidden');

            setTimeout(() => {
                toastElement.classList.remove('show');
                setTimeout(() => toastElement.classList.add('hidden'), 300); 
            }, 3000); 
        }
        
        /**
         * Anima o botão para indicar carregamento ou erro.
         */
        function animateButton(button, type) {
            const iElement = button.querySelector('i');
            
            // Função auxiliar para obter a classe original do botão (deposit/cancel)
            function originalClass(btn) {
                return btn.classList.contains('deposit') ? 'submit-btn deposit' : 'submit-btn cancel';
            }

            button.className = originalClass(button); // Reset classes de animação

            if (type === 'loading') {
                button.disabled = true;
                button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Processando...`;
            } else if (type === 'success') {
                button.disabled = true;
                button.classList.add('success-animate');
                iElement.className = 'fas fa-check-circle';
                
                setTimeout(() => {
                    button.disabled = false;
                    // Nâo volta ao texto original aqui, pois vai abrir o modal
                }, 1500);
            } else if (type === 'error') {
                button.disabled = true;
                button.classList.add('error-animate');
                iElement.className = 'fas fa-times-circle';
                
                setTimeout(() => {
                    button.disabled = false;
                    button.innerHTML = `<i class="fas fa-check-circle"></i> ${translations.pt.modalConfirmButton}`;
                }, 1500);
            }
        }
        
        /**
         * Exibe o modal de sucesso.
         */
        function showSuccessModal(amount) {
            const modal = document.getElementById('successModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalText = document.getElementById('modalText');
            
            modalTitle.textContent = translations.pt.modalTitleDeposit;
            modalText.textContent = translations.pt.modalTextDeposit.replace('{amount}', amount.toFixed(2));

            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function closeSuccessModal() {
            const modal = document.getElementById('successModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.classList.add('hidden');
                window.location.href = 'deposit-history.html';
            }, 300);
        }
        
        function setInlineError(elementId, message, hide = false) {
             const errorElement = document.getElementById(elementId);
             if (errorElement) {
                 errorElement.textContent = message;
                 errorElement.classList.toggle('hidden', hide || message === '');
             }
        }

        // --- 1. Busca Configuração do Admin (REAL) ---
        async function fetchDepositConfig() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/deposit-config`); 
                if (!response.ok) {
                    throw new Error(`Falha ao carregar configurações (Status: ${response.status})`);
                }
                const data = await response.json();
                
                // Mapeia para a estrutura que precisamos:
                DEPOSIT_CONFIG = {
                    'M-Pesa': { 
                        name: data.config.mpesaRecipientName || 'M-Pesa Admin', 
                        phoneNumber: data.config.mpesaDepositNumber || '840000000' 
                    },
                    'Emola': { 
                        name: data.config.emolaRecipientName || 'Emola Admin', 
                        phoneNumber: data.config.emolaDepositNumber || '870000000' 
                    }
                };
                return true;
            } catch (error) {
                console.error("Erro ao buscar configurações de depósito:", error);
                return false;
            }
        }

        // --- 2. Inicializa o Checkout ---
        async function initializeCheckout() {
            const timerDisplay = document.getElementById('timerDisplay');
            timerDisplay.textContent = translations.pt.loadingConfig;
            
            // 1. Puxa os dados da sessionStorage (Redireciona se falhar)
            const depositData = JSON.parse(sessionStorage.getItem('depositData'));
            if (!depositData || !depositData.amount || !depositData.method) {
                showToast('Nenhum dado de depósito encontrado. Retornando para a Carteira.', 'error');
                setTimeout(() => window.location.href = 'wallet.html', 1500);
                return;
            }
            
            // 2. Busca as Configurações do Admin (REAL)
            const configLoaded = await fetchDepositConfig();
            if (!configLoaded) {
                 timerDisplay.textContent = 'Erro de Configuração';
                 showToast('Falha ao carregar configurações de depósito do Admin. Contate o suporte.', 'error');
                 return;
            }
            const config = DEPOSIT_CONFIG[depositData.method];

            // 3. Preenche o HTML com dados Reais
            document.getElementById('checkoutAmount').textContent = `${depositData.amount.toFixed(2)} MT`;
            document.getElementById('checkoutMethod').textContent = depositData.method;
            document.getElementById('checkoutRecipientName').textContent = config.name;
            document.getElementById('checkoutPhoneNumber').textContent = config.phoneNumber;

            // 4. Aplica tradução e instruções
            document.querySelector('p[data-translate-key="checkoutInstruction"]').innerHTML = translations.pt.checkoutInstruction
                .replace('{amount}', depositData.amount.toFixed(2))
                .replace('{method}', `<span style="color: ${depositData.method === 'M-Pesa' ? 'red' : 'green'};">${depositData.method}</span>`);

            // 5. Inicia o Timer e Configura o Formulário
            startTimer(CHECKOUT_DURATION, document.getElementById('timerDisplay'));
            document.getElementById('checkoutConfirmationForm').addEventListener('submit', (e) => handleCheckoutConfirmation(e, depositData));
        }

        // --- Funções de Timer e Navegação (Mantidas) ---
        function startTimer(duration, display) {
            let timer = duration;
            clearInterval(timerInterval); // Garante que o timer anterior seja limpo
            timerInterval = setInterval(function () {
                const minutes = parseInt(timer / 60, 10);
                const seconds = parseInt(timer % 60, 10);

                display.textContent = `${minutes < 10 ? "0" + minutes : minutes}:${seconds < 10 ? "0" + seconds : seconds}`;

                if (--timer < 0) {
                    clearInterval(timerInterval);
                    showToast(translations.pt.timerExpired, 'error');
                    sessionStorage.removeItem('depositData'); 
                    setTimeout(() => window.location.href = 'wallet.html', 1500);
                }
            }, 1000);
        }

        function cancelCheckout() {
            clearInterval(timerInterval);
            sessionStorage.removeItem('depositData');
            window.location.href = 'wallet.html';
        }

        // --- 3. Lida com a Confirmação do Checkout (REAL) ---
        async function handleCheckoutConfirmation(event, depositData) {
            event.preventDefault();
            clearInterval(timerInterval); 
            
            const form = event.target;
            const button = form.querySelector('.submit-btn');
            const confirmationMessage = document.getElementById('confirmationMessage').value.trim();
            
            setInlineError('checkoutError', '', true);

            if (confirmationMessage.length < 5) {
                setInlineError('checkoutError', translations.pt.confirmationRequired);
                animateButton(button, 'error');
                // Reinicia o timer por um breve período para dar chance de corrigir (5 segundos)
                startTimer(5, document.getElementById('timerDisplay')); 
                return;
            }

            animateButton(button, 'loading');
            
            // Prepara a string do comprovativo para o backend (Incluindo Método e Valor)
            const confirmationDetails = `Método: ${depositData.method}, Valor: ${depositData.amount.toFixed(2)} MT, Comprovativo: ${confirmationMessage}`;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${BACKEND_URL}/api/deposits`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ amount: depositData.amount, confirmationMessage: confirmationDetails }) 
                });

                const data = await response.json();

                if (response.ok) {
                    animateButton(button, 'success');
                    sessionStorage.removeItem('depositData'); 
                    showSuccessModal(depositData.amount); // Abre o modal de sucesso

                } else if (response.status === 401 || response.status === 403) {
                    sessionStorage.removeItem('depositData');
                    throw new Error("sessionExpired");
                } else {
                    throw new Error(data.message || translations.pt.requestFailed);
                }
            } catch (error) {
                animateButton(button, 'error');
                if (error.message.includes("sessionExpired")) {
                    showToast(translations.pt.sessionExpired, 'error');
                    localStorage.removeItem('token');
                    setTimeout(() => window.location.href = 'login.html', 1500);
                } else {
                    setInlineError('checkoutError', `${translations.pt.requestFailed} ${error.message}`);
                }
                
                // Volta o timer completo em caso de erro na API
                startTimer(CHECKOUT_DURATION, document.getElementById('timerDisplay')); 
            }
        }

        function copyToClipboard(elementId, buttonElement) {
             const textToCopy = document.getElementById(elementId).textContent.trim();
             navigator.clipboard.writeText(textToCopy).then(() => {
                const originalText = buttonElement.className;
                buttonElement.className = `copy-btn fas fa-check`;
                showToast(translations.pt.copySuccess, 'success');
                setTimeout(() => buttonElement.className = originalText, 1000);
             });
        }
    </script>
</body>
</html>