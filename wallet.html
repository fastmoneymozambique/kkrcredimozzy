<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="walletTitle">KKR Credit | Carteira</title>
    <!-- Favicon -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <!-- Google Fonts - Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome para ícones (CDN) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- CSS EMBUTIDO AQUI -->
    <style>
        /* Variáveis CSS (Consistente) */
        :root {
            --primary-purple: #6a0dad;
            --light-purple: #9b59b6;
            --hover-purple: #8e44ad;
            --dark-background: #2c3e50;
            --text-dark: #333;
            --text-medium: #666;
            --text-light: #555;
            --border-light: #e0e0e0;
            --white: #ffffff;
            --card-bg-light: #f7faff;
            --success-green: #2ecc71;
            --error-red: #e74c3c;
            --app-background: #e0e6ec;
            --info-blue: #3498db;
            --deposit-color: #007bff; 
            --withdrawal-color: #dc3545; 
            --warning-yellow: #f1c40f; 
        }

        /* Base e Estrutura */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; line-height: 1.6; color: var(--text-dark); background-color: var(--app-background); min-height: 100vh; display: flex; flex-direction: column; }
        .page-wrapper { max-width: 480px; width: 100%; margin: 0 auto; background-color: var(--card-bg-light); min-height: 100vh; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: var(--white); border-bottom: 1px solid var(--border-light); position: sticky; top: 0; z-index: 100; }
        .app-header .logo { font-size: 1.5em; font-weight: 700; color: var(--primary-purple); }
        .back-button { background: none; border: none; color: var(--text-medium); font-size: 1.2em; cursor: pointer; transition: color 0.2s ease; padding: 5px; }
        .back-button:hover { color: var(--primary-purple); }
        .main-content { flex-grow: 1; padding: 20px; padding-bottom: 80px; overflow-y: auto; }
        .page-title { font-size: 1.8em; color: var(--primary-purple); font-weight: 700; margin-bottom: 25px; text-align: center; }

        /* Card de Saldo */
        .balance-card { background-color: var(--primary-purple); border-radius: 15px; padding: 25px; color: var(--white); margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .balance-card h2 { font-size: 1.2em; color: rgba(255,255,255,0.8); margin-bottom: 15px; }
        .balance-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .balance-item:last-child { border-bottom: none; }
        .balance-item .label { font-size: 0.9em; font-weight: 500; }
        .balance-item .value { font-size: 1.4em; font-weight: 700; color: var(--success-green); }

        /* Abas e Formulários */
        .action-tabs { display: flex; margin-bottom: 25px; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .action-tabs .tab-button { flex: 1; padding: 15px 10px; background-color: var(--white); color: var(--text-dark); border: none; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .action-tabs .tab-button.active { color: var(--white); background-color: var(--primary-purple); }
        .action-tabs .tab-button:not(.active):hover { background-color: var(--card-bg-light); color: var(--primary-purple); }
        .action-form { background-color: var(--white); border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--text-dark); font-weight: 500; }
        .input-group input, .input-group select { width: 100%; padding: 10px 15px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 1em; transition: border-color 0.2s; }
        .input-group input:focus, .input-group select:focus { border-color: var(--primary-purple); outline: none; }
        .submit-btn { width: 100%; padding: 12px; color: var(--white); border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease, transform 0.1s ease; margin-top: 10px; display: flex; align-items: center; justify-content: center; }
        .submit-btn.deposit { background-color: var(--deposit-color); }
        .submit-btn.deposit:hover { background-color: #0056b3; }
        .submit-btn.withdraw { background-color: var(--withdrawal-color); }
        .submit-btn.withdraw:hover { background-color: #b3001e; }
        .submit-btn:disabled { background-color: var(--text-medium); cursor: not-allowed; }
        .submit-btn i { margin-right: 5px; }

        /* Estilo de Mensagem de Erro em linha (em substituição a error-message) */
        .inline-error {
            color: var(--error-red);
            font-size: 0.85em;
            margin-top: 5px;
            display: block;
        }

        /* Navegação Inferior */
        .bottom-nav { display: flex; justify-content: space-around; align-items: center; padding: 10px 0; background-color: var(--white); border-top: 1px solid var(--border-light); box-shadow: 0 -5px 15px rgba(0,0,0,0.05); width: 100%; max-width: 480px; position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-medium); font-size: 0.7em; cursor: pointer; transition: color 0.2s ease; padding: 5px 0; flex: 1; }
        .nav-item i { font-size: 1.3em; margin-bottom: 3px; }
        .nav-item.active { color: var(--primary-purple); font-weight: 600; }
        .nav-item:hover { color: var(--primary-purple); }

        /* Estilo para a mensagem de horário de saque */
        .withdrawal-info-message {
            font-size: 0.9em;
            color: var(--text-dark);
            background-color: var(--card-bg-light);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid var(--border-light);
        }

        /* --- NOVO: Estilo para Modal de Sucesso --- */
        .success-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .success-modal.show {
            opacity: 1;
        }
        .modal-content-box {
            background-color: var(--white);
            border-radius: 15px;
            padding: 30px;
            width: 80%;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Animação elástica */
        }
        .success-modal.show .modal-content-box {
            transform: scale(1);
        }
        .success-icon {
            font-size: 4em;
            color: var(--success-green);
            margin-bottom: 15px;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.9); }
            50% { transform: scale(1); }
            100% { transform: scale(0.9); }
        }
        .modal-content-box h3 {
            color: var(--text-dark);
            margin-bottom: 10px;
        }
        .modal-content-box p {
            color: var(--text-medium);
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        .modal-content-box button {
            background-color: var(--success-green);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        /* --- FIM: Estilo para Modal de Sucesso --- */
        
        /* --- Estilo para Toast Notification --- */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            width: 90%;
            max-width: 400px;
            pointer-events: none; 
        }
        .toast {
            background-color: var(--white);
            color: var(--text-dark);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(-20px);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success { border-left: 5px solid var(--success-green); }
        .toast.error { border-left: 5px solid var(--error-red); }
        .toast.info { border-left: 5px solid var(--info-blue, #3498db); }
        .toast i { font-size: 1.2em; }
        .toast.success i { color: var(--success-green); }
        .toast.error i { color: var(--error-red); }
        .toast.info i { color: var(--info-blue, #3498db); }
        /* --- FIM: Estilo para Toast Notification --- */
        
        /* Estilo para animação de botão (Feedback de Sucesso e Erro) */
        .submit-btn.success-animate {
            background-color: var(--success-green) !important;
            transition: all 0.1s ease-in-out;
        }
        .submit-btn.error-animate {
            background-color: var(--error-red) !important;
            transition: all 0.1s ease-in-out;
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .hidden { display: none !important; }

    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container">
        <div id="appToast" class="toast hidden">
            <i class="fas fa-info-circle"></i>
            <span id="toastMessage">Mensagem</span>
        </div>
    </div>
    
    <!-- NOVO: Modal de Sucesso -->
    <div id="successModal" class="success-modal hidden">
        <div class="modal-content-box">
            <i class="fas fa-check-circle success-icon"></i>
            <h3 id="modalTitle">Sucesso!</h3>
            <p id="modalText">Sua transação foi processada com sucesso e será atualizada em breve.</p>
            <button onclick="closeSuccessModal()">OK</button>
        </div>
    </div>
    <!-- FIM NOVO: Modal de Sucesso -->
    
    <div class="page-wrapper">
        <!-- Header -->
        <header class="app-header">
            <button class="back-button" onclick="navigateTo('home');" data-translate-key="backButtonAlt">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="logo">KKR Credit</div>
            <div></div> 
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <h1 class="page-title" data-translate-key="walletHeader">Minha Carteira</h1>

            <!-- Card de Saldo -->
            <section class="balance-card">
                <h2 data-translate-key="balanceSummary">Resumo do Saldo</h2>
                <p id="loadingMessage" class="message hidden" data-translate-key="loadingBalance">Carregando saldo...</p>

                <div class="balance-item">
                    <span class="label" data-translate-key="availableBalance">Saldo Disponível:</span>
                    <span class="value" id="mainBalance">0.00 MT</span>
                </div>
            </section>

            <!-- Abas de Ação -->
            <section class="action-tabs">
                <button id="depositTab" class="tab-button active" onclick="switchTab('deposit')" data-translate-key="depositTab">Depositar</button>
                <button id="withdrawTab" class="tab-button" onclick="switchTab('withdraw')" data-translate-key="withdrawTab">Sacar</button>
            </section>

            <!-- Formulário de Depósito -->
            <section id="depositFormContainer" class="action-form">
                <h3 data-translate-key="depositHeader">Solicitar Depósito</h3>
                <form id="depositForm">
                    <div class="input-group">
                        <label for="paymentMethodDeposit" data-translate-key="paymentMethodLabel">Método de Pagamento</label>
                        <select id="paymentMethodDeposit" name="paymentMethodDeposit" required>
                            <option value="M-Pesa">M-Pesa</option>
                            <option value="Emola">Emola</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="depositAmount" data-translate-key="amountLabel">Valor (MT)</label>
                        <input type="number" id="depositAmount" name="amount" placeholder="Mínimo 50 MT" min="50" step="any" required>
                        <span id="depositError" class="inline-error hidden"></span>
                    </div>
                    <button type="submit" class="submit-btn deposit" data-translate-key="depositButton">
                        <i class="fas fa-download"></i> Depositar
                    </button>
                </form>
            </section>

            <!-- Formulário de Saque -->
            <section id="withdrawFormContainer" class="action-form hidden"> 
                <h3 data-translate-key="withdrawHeader">Solicitar Saque</h3>
                
                <!-- Mensagem de Horário de Saque -->
                <div id="withdrawalTimeInfo" class="withdrawal-info-message hidden">
                    <i class="fas fa-clock"></i> <span id="withdrawalTimeText">Carregando horário de saque...</span>
                </div>
                
                <form id="withdrawForm">
                    <div class="input-group">
                        <label for="paymentMethodWithdraw" data-translate-key="paymentMethodLabel">Método de Pagamento</label>
                        <select id="paymentMethodWithdraw" name="paymentMethodWithdraw" required>
                            <option value="M-Pesa">M-Pesa</option>
                            <option value="Emola">Emola</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="withdrawAmount" data-translate-key="amountLabel">Valor (MT)</label>
                        <input type="number" id="withdrawAmount" name="amount" min="1" step="any" required>
                        <span id="withdrawError" class="inline-error hidden"></span>
                    </div>
                    <div class="input-group">
                        <label for="recipientName" data-translate-key="recipientNameLabel">Nome Completo do Destinatário</label>
                        <input type="text" id="recipientName" name="recipientName" required>
                    </div>
                    <div class="input-group">
                        <label for="recipientPhoneNumber" data-translate-key="recipientPhoneLabel">Número do Destinatário</label>
                        <input type="tel" id="recipientPhoneNumber" name="recipientPhoneNumber" placeholder="Ex: 84xxxxxxx" required pattern="^\d{9}$">
                    </div>
                    
                    <button type="submit" class="submit-btn withdraw" data-translate-key="withdrawButton">
                         <i class="fas fa-upload"></i> Solicitar Saque
                    </button>
                </form>
            </section>

        </main> <!-- Fim do main-content -->
        
        <!-- Bottom Navigation Bar (Consistente) -->
        <nav class="bottom-nav">
            <div class="nav-item" onclick="navigateTo('home');">
                <i class="fas fa-home"></i>
                <span data-translate-key="navHome">Home</span>
            </div>
            <div class="nav-item" onclick="navigateTo('pool');">
                <i class="fas fa-coins"></i>
                <span data-translate-key="navPool">Pacotes</span>
            </div>
            <div class="nav-item" onclick="navigateTo('income');">
                <i class="fas fa-chart-line"></i>
                <span data-translate-key="navIncome">Renda</span>
            </div>
            <div class="nav-item active" onclick="navigateTo('wallet');">
                <i class="fas fa-wallet"></i>
                <span data-translate-key="navWallet">Carteira</span>
            </div>
            <div class="nav-item" onclick="navigateTo('profile');">
                <i class="fas fa-user"></i>
                <span data-translate-key="navProfile">Perfil</span>
            </div>
        </nav>

    </div> <!-- Fim do page-wrapper -->

    <!-- Script para lógica da Carteira EMBUTIDO AQUI -->
    <script>
        // IIFE para garantir o escopo e a ordem de execução
        (function() {
            const BACKEND_URL = 'https://backend-cjl7.onrender.com';
            const MIN_DEPOSIT_AMOUNT = 50;
            let currentAvailableBalance = 0;
            let currentLang = 'pt'; 
            let withdrawalTimeConfig = null; 
            
            // Objeto de traduções
            const translations = {
                en: {
                    walletTitle: 'KKR Credit | Wallet', backButtonAlt: 'Back', walletHeader: 'My Wallet', balanceSummary: 'Balance Summary', loadingBalance: 'Loading balance...', availableBalance: 'Available Balance:', depositTab: 'Deposit', withdrawTab: 'Withdraw', depositHeader: 'Request Deposit', withdrawHeader: 'Request Withdrawal', amountLabel: 'Amount (MT)', paymentMethodLabel: 'Payment Method', depositButton: 'Deposit', withdrawButton: 'Request Withdrawal', recipientNameLabel: 'Full Recipient Name', recipientPhoneLabel: 'Recipient Number', minAmountError: `The minimum deposit amount is ${MIN_DEPOSIT_AMOUNT} MT.`, minWithdrawalError: 'The minimum withdrawal amount is {min} MT.', maxWithdrawalError: 'The maximum withdrawal amount is {max} MT.', insufficientBalance: 'Insufficient available balance for this withdrawal.', depositSuccess: 'Deposit request sent! Proceed to checkout.', withdrawSuccess: 'Withdrawal request sent for approval.', requestFailed: 'Request failed:', networkError: 'A network error occurred. Check your connection or try again later.', sessionExpired: 'Session expired or unauthorized. Please log in again.', navHome: 'Home', navPool: 'Packages', navIncome: 'Income', navWallet: 'Wallet', navProfile: 'Profile',
                    withdrawalTimeAllowed: 'Withdrawals are allowed from {start} to {end} (MZ Time).',
                    withdrawalTimeRestricted: 'Withdrawal time is from {start} to {end} (MZ Time).',
                    withdrawPlaceholder: 'Min. {min} MT / Max. {max} MT',
                    modalTitleDeposit: 'Depósito Solicitado',
                    modalTitleWithdraw: 'Saque Solicitado',
                    modalTextDeposit: 'Aguardando o comprovativo no Checkout. Redirecionando...',
                    modalTextWithdraw: 'Aguardando aprovação. O saldo será creditado em sua conta de destino em breve.',
                },
                pt: {
                    walletTitle: 'KKR Credit | Carteira', backButtonAlt: 'Voltar', walletHeader: 'Minha Carteira', balanceSummary: 'Resumo do Saldo', loadingBalance: 'Carregando saldo...', availableBalance: 'Saldo Disponível:', depositTab: 'Depositar', withdrawTab: 'Sacar', depositHeader: 'Solicitar Depósito', withdrawHeader: 'Solicitar Saque', amountLabel: 'Valor (MT)', paymentMethodLabel: 'Método de Pagamento', depositButton: 'Depositar', withdrawButton: 'Solicitar Saque', recipientNameLabel: 'Nome Completo do Destinatário', recipientPhoneLabel: 'Número do Destinatário', minAmountError: `O valor mínimo de depósito é ${MIN_DEPOSIT_AMOUNT} MT.`, minWithdrawalError: 'O saque mínimo é {min} MT.', maxWithdrawalError: 'O saque máximo é {max} MT.', insufficientBalance: 'Saldo disponível insuficiente para este saque.', depositSuccess: 'Solicitação de depósito enviada! Prossiga para o checkout.', withdrawSuccess: 'Solicitação de saque enviada para aprovação.', requestFailed: 'Falha na solicitação:', networkError: 'Ocorreu um erro de rede. Verifique sua conexão ou tente novamente mais tarde.', sessionExpired: 'Sessão expirada ou não autorizada. Por favor, faça login novamente.', navHome: 'Home', navPool: 'Pacotes', navIncome: 'Renda', navWallet: 'Carteira', navProfile: 'Perfil',
                    withdrawalTimeAllowed: 'Saques permitidos das {start} às {end} (MZ Time).',
                    withdrawalTimeRestricted: 'O horário de saque é das {start} às {end} (MZ Time).',
                    withdrawPlaceholder: 'Mín. {min} MT / Máx. {max} MT', 
                    modalTitleDeposit: 'Depósito Solicitado',
                    modalTitleWithdraw: 'Saque Solicitado',
                    modalTextDeposit: 'Aguardando o comprovativo no Checkout. Redirecionando...',
                    modalTextWithdraw: 'Aguardando aprovação. O saldo será creditado em sua conta de destino em breve.',
                }
            };


            document.addEventListener('DOMContentLoaded', () => {
                loadLanguagePreference(); 
                applyTranslations(currentLang);
                fetchInitialData(); 
                
                document.getElementById('depositForm').addEventListener('submit', handleInitialDepositRequest); 
                document.getElementById('withdrawForm').addEventListener('submit', handleWithdrawalRequest);
            });
            
            // --- FUNÇÕES EXPOSTAS PARA O HTML ---
            window.switchTab = switchTab;
            window.navigateTo = navigateTo;
            window.closeSuccessModal = closeSuccessModal;
            
            // --- UI/Animação/Toast/Modal ---
            
            /**
             * Exibe uma notificação Toast no topo da página. (Reservado para Erros e Info)
             * @param {string} message - A mensagem a ser exibida.
             * @param {string} [type='info'] - O tipo de notificação ('success', 'error', 'info').
             */
            function showToast(message, type = 'info') {
                const toastElement = document.getElementById('appToast');
                const toastMessage = document.getElementById('toastMessage');
                const icon = toastElement.querySelector('i');

                if (!toastElement || !toastMessage || !icon) return;

                toastElement.classList.remove('show', 'success', 'error', 'info');
                toastElement.classList.add('hidden');

                toastElement.className = 'toast show';
                icon.className = 'fas';
                
                if (type === 'success') {
                    toastElement.classList.add('success');
                    icon.classList.add('fa-check-circle');
                } else if (type === 'error') {
                    toastElement.classList.add('error');
                    icon.classList.add('fa-times-circle');
                } else {
                    toastElement.classList.add('info');
                    icon.classList.add('fa-info-circle');
                }

                toastMessage.textContent = message;
                toastElement.classList.remove('hidden');

                setTimeout(() => {
                    toastElement.classList.remove('show');
                    setTimeout(() => toastElement.classList.add('hidden'), 300); 
                }, 3000); 
            }
            
            /**
             * Anima o botão para indicar carregamento ou erro.
             * @param {HTMLElement} button - O elemento do botão.
             * @param {string} type - 'loading', 'success', ou 'error'.
             */
            function animateButton(button, type) {
                const iElement = button.querySelector('i');
                const originalText = button.dataset.translateKey;
                const originalIcon = iElement ? iElement.className : '';
                
                // Função auxiliar para obter a classe original do botão (deposit/withdraw)
                function originalClass(btn) {
                    return btn.classList.contains('deposit') ? 'submit-btn deposit' : 'submit-btn withdraw';
                }

                button.className = originalClass(button); // Reset classes de animação

                if (type === 'loading') {
                    button.disabled = true;
                    button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${button.dataset.translateKey === 'depositButton' ? 'Processando...' : 'Enviando...'}`;
                } else if (type === 'success') {
                    button.disabled = true;
                    button.classList.add('success-animate');
                    iElement.className = 'fas fa-check-circle';
                    
                    setTimeout(() => {
                        button.disabled = false;
                        // Retorna ao estado original (reaplica a tradução)
                        applyTranslations(currentLang); 
                    }, 1500);
                } else if (type === 'error') {
                    button.disabled = true;
                    button.classList.add('error-animate');
                    iElement.className = 'fas fa-times-circle';
                    
                    setTimeout(() => {
                        button.disabled = false;
                        // Retorna ao estado original (reaplica a tradução)
                        applyTranslations(currentLang);
                    }, 1500);
                }
            }
            
            /**
             * Exibe o modal de sucesso com a mensagem apropriada.
             * @param {string} type - 'Withdraw'.
             */
            function showSuccessModal(type) {
                const modal = document.getElementById('successModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalText = document.getElementById('modalText');
                
                modalTitle.textContent = translations[currentLang][`modalTitle${type}`];
                modalText.textContent = translations[currentLang][`modalText${type}`];

                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.add('show'), 10);
            }

            function closeSuccessModal() {
                const modal = document.getElementById('successModal');
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
            
            function setInlineError(elementId, message, hide = false) {
                 const errorElement = document.getElementById(elementId);
                 if (errorElement) {
                     errorElement.textContent = message;
                     errorElement.classList.toggle('hidden', hide || message === '');
                 }
            }


            // --- Implementações de Funções (Consistentes) ---
            
            function loadLanguagePreference() {
                const savedLang = localStorage.getItem('langPreference');
                if (savedLang) {
                    const { lang } = JSON.parse(savedLang);
                    currentLang = lang;
                }
            }

            function applyTranslations(lang) {
                document.querySelectorAll('[data-translate-key]').forEach(element => {
                    const key = element.dataset.translateKey;
                    if (translations[lang] && translations[lang][key]) {
                        if (element.tagName === 'TITLE') {
                            document.title = translations[lang][key];
                        } else if (element.tagName === 'BUTTON' || element.tagName === 'A') {
                            // Deixa os botões com ícones terem o texto atualizado pelo innerHTML
                            const icon = element.querySelector('i');
                            const iconHtml = icon ? icon.outerHTML : '';
                            element.innerHTML = `${iconHtml} ${translations[lang][key]}`;
                        } else if (element.tagName !== 'I' && element.tagName !== 'SELECT' && element.tagName !== 'INPUT') {
                            element.textContent = translations[lang][key];
                        }
                    }
                });
                if(document.getElementById('depositAmount')) document.getElementById('depositAmount').placeholder = `Mínimo ${MIN_DEPOSIT_AMOUNT} MT`;
            }


            function navigateTo(page) {
                const pageMap = {
                    'home': 'dashboard.html',
                    'pool': 'pool.html',
                    'income': 'income.html',
                    'wallet': 'wallet.html',
                    'profile': 'profile.html',
                };
                const targetPage = pageMap[page];
                if (targetPage) {
                    window.location.href = targetPage;
                }
            }

            function switchTab(tab) {
                const depositContainer = document.getElementById('depositFormContainer');
                const withdrawContainer = document.getElementById('withdrawFormContainer');
                const depositTabBtn = document.getElementById('depositTab');
                const withdrawTabBtn = document.getElementById('withdrawTab');

                setInlineError('depositError', '', true);
                setInlineError('withdrawError', '', true);

                if (tab === 'deposit') {
                    depositContainer.classList.remove('hidden');
                    withdrawContainer.classList.add('hidden');
                    depositTabBtn.classList.add('active');
                    withdrawTabBtn.classList.remove('active');
                } else if (tab === 'withdraw') {
                    depositContainer.classList.add('hidden');
                    withdrawContainer.classList.remove('hidden');
                    depositTabBtn.classList.remove('active');
                    withdrawTabBtn.classList.add('active');
                }
            }

            // --- NOVO: Busca saldo E Configuração de Saque ---
            async function fetchInitialData() {
                 await Promise.all([
                    fetchUserBalance(),
                    fetchAdminWithdrawalConfig()
                 ]).catch(error => {
                    console.error("[DIAGNÓSTICO] Erro em uma das chamadas iniciais da Carteira:", error);
                 });
            }

            // --- 1. Busca Saldo do Usuário ---
            async function fetchUserBalance() {
                const token = localStorage.getItem('token');
                const loadingMessage = document.getElementById('loadingMessage');
                
                if (!token) {
                    loadingMessage.textContent = translations[currentLang].sessionExpired;
                    setTimeout(() => window.location.href = 'login.html', 2000);
                    return;
                }

                loadingMessage.classList.remove('hidden');

                try {
                    const response = await fetch(`${BACKEND_URL}/api/profile`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.status === 401 || response.status === 403) {
                        throw new Error("sessionExpired");
                    }
                    
                    const data = await response.json();
                    
                    currentAvailableBalance = data.user.balance || 0;

                    document.getElementById('mainBalance').textContent = `${currentAvailableBalance.toFixed(2)} MT`;

                } catch (error) {
                    const message = error.message.includes("sessionExpired") ? 
                        translations[currentLang].sessionExpired : 
                        translations[currentLang].networkError;
                    
                    loadingMessage.textContent = message;
                    
                    if (error.message.includes("sessionExpired")) {
                        localStorage.removeItem('token');
                        showToast(translations[currentLang].sessionExpired, 'error');
                        setTimeout(() => window.location.href = 'login.html', 2000);
                    }
                } finally {
                    loadingMessage.classList.add('hidden');
                }
            }

            // --- 2. Busca Configuração de Horário e Limites de Saque ---
            async function fetchAdminWithdrawalConfig() {
                const infoElement = document.getElementById('withdrawalTimeInfo');
                const textElement = document.getElementById('withdrawalTimeText');
                const withdrawInput = document.getElementById('withdrawAmount');
                const withdrawButton = document.querySelector('#withdrawForm .submit-btn');

                infoElement.classList.remove('hidden');

                try {
                    const response = await fetch(`${BACKEND_URL}/api/deposit-config`); 
                    if (!response.ok) {
                        throw new Error(`Status ${response.status}`);
                    }
                    const data = await response.json();
                    
                    withdrawalTimeConfig = data.config;
                    const { withdrawalStartTime: start, withdrawalEndTime: end, minWithdrawalAmount: min, maxWithdrawalAmount: max } = withdrawalTimeConfig;

                    // 1. Atualiza Placeholder do Input
                    const placeholderText = translations[currentLang].withdrawPlaceholder
                        .replace('{min}', min || 1)
                        .replace('{max}', max || 5000);
                        
                    withdrawInput.placeholder = placeholderText;
                    withdrawInput.min = min || 1; 
                    withdrawInput.max = max || 5000; 


                    // 2. Atualiza Mensagem de Horário
                    if (start && end) {
                        const now = new Date();
                        const isAllowed = isTimeAllowed(now, start, end);
                        
                        const timeText = (isAllowed ? translations[currentLang].withdrawalTimeAllowed : translations[currentLang].withdrawalTimeRestricted)
                            .replace('{start}', start)
                            .replace('{end}', end);

                        textElement.innerHTML = timeText;
                        if (!isAllowed) {
                           infoElement.classList.remove('info-message'); 
                           infoElement.classList.add('error-message');
                           withdrawButton.disabled = true;
                           withdrawButton.innerHTML = `<i class="fas fa-ban"></i> Fora do Horário de Saque`;
                        } else {
                            infoElement.classList.remove('error-message');
                            infoElement.classList.add('info-message');
                            withdrawButton.disabled = false;
                            applyTranslations(currentLang); // Reaplica a tradução para restaurar o ícone
                        }

                    } else {
                        textElement.textContent = "Horário de saque não configurado. Saques podem estar indisponíveis.";
                        infoElement.classList.add('error-message');
                        withdrawButton.disabled = true; 
                    }


                } catch (error) {
                    textElement.textContent = "Erro ao carregar horário/limites de saque.";
                    infoElement.classList.add('error-message');
                    withdrawButton.disabled = true; 
                }
            }

            /**
             * Auxiliar para verificar se a hora atual está dentro do intervalo HH:MM.
             */
            function isTimeAllowed(now, startTime, endTime) {
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();

                const parseTime = (timeStr) => {
                    const [hour, minute] = timeStr.split(':').map(Number);
                    if (isNaN(hour) || isNaN(minute)) return -1; 
                    return hour * 60 + minute;
                };

                const currentTimeInMinutes = currentHour * 60 + currentMinute;
                const startTimeInMinutes = parseTime(startTime);
                const endTimeInMinutes = parseTime(endTime);

                return currentTimeInMinutes >= startTimeInMinutes && currentTimeInMinutes <= endTimeInMinutes;
            }


            // --- 3. Lida com a Solicitação de Depósito (FLUXO FINAL) ---
            async function handleInitialDepositRequest(event) {
                event.preventDefault();
                setInlineError('depositError', '', true);

                const button = event.target.querySelector('.submit-btn');
                
                const amountInput = document.getElementById('depositAmount');
                const methodInput = document.getElementById('paymentMethodDeposit');
                
                if (!amountInput || !methodInput) return;

                const amount = parseFloat(amountInput.value);
                const method = methodInput.value;

                if (isNaN(amount) || amount < MIN_DEPOSIT_AMOUNT) {
                    setInlineError('depositError', translations[currentLang].minAmountError);
                    animateButton(button, 'error');
                    return;
                }
                
                // 1. Animação de Carregamento
                animateButton(button, 'loading');
                
                try {
                    // Prepara o sessionStorage para o checkout
                    const depositData = { amount, method };
                    sessionStorage.setItem('depositData', JSON.stringify(depositData));
                    
                    // 2. Animação de Sucesso
                    animateButton(button, 'success');
                    
                    // 3. Redirecionamento direto após a animação
                    setTimeout(() => window.location.href = 'deposit_checkout.html', 1500);
                    
                } catch (e) {
                    animateButton(button, 'error');
                    setInlineError('depositError', "Erro ao iniciar o checkout.", 'error');
                }
            }

            // --- 4. Lida com a Solicitação de Saque (FINAL) ---
            async function handleWithdrawalRequest(event) {
                event.preventDefault();
                const form = event.target;
                const button = form.querySelector('.submit-btn');
                setInlineError('withdrawError', '', true);
                
                const amount = parseFloat(document.getElementById('withdrawAmount').value);
                const recipientName = document.getElementById('recipientName').value.trim();
                const recipientPhoneNumber = document.getElementById('recipientPhoneNumber').value.trim();
                const paymentMethod = document.getElementById('paymentMethodWithdraw').value;

                // --- VALIDAÇÕES DE FRONT-END ---
                const min = withdrawalTimeConfig ? withdrawalTimeConfig.minWithdrawalAmount : 1;
                const max = withdrawalTimeConfig ? withdrawalTimeConfig.maxWithdrawalAmount : Infinity;

                if (isNaN(amount) || amount < min) {
                    setInlineError('withdrawError', translations[currentLang].minWithdrawalError.replace('{min}', min));
                    animateButton(button, 'error');
                    return;
                }
                if (amount > max) {
                    setInlineError('withdrawError', translations[currentLang].maxWithdrawalError.replace('{max}', max));
                    animateButton(button, 'error');
                    return;
                }
                if (amount > currentAvailableBalance) {
                    setInlineError('withdrawError', translations[currentLang].insufficientBalance);
                    animateButton(button, 'error');
                    return;
                }
                if (recipientName.length < 3) {
                    setInlineError('withdrawError', 'O Nome Completo do Destinatário deve ter pelo menos 3 caracteres.');
                    animateButton(button, 'error');
                    return;
                }
                if (recipientPhoneNumber.length !== 9 || !/^\d{9}$/.test(recipientPhoneNumber)) {
                    setInlineError('withdrawError', 'O Número do Destinatário deve ter exatamente 9 dígitos numéricos.');
                    animateButton(button, 'error');
                    return;
                }
                if (button.disabled && button.textContent.includes("Horário")) {
                     setInlineError('withdrawError', "Saque fora do horário permitido. Aguarde o horário de abertura.");
                     animateButton(button, 'error');
                     return;
                }
                // --- FIM DA VALIDAÇÃO DE FRONT-END ---

                animateButton(button, 'loading');
                const walletAddressDetails = `Método: ${paymentMethod}, Nome: ${recipientName}, Telefone: ${recipientPhoneNumber}`;

                try {
                    const token = localStorage.getItem('token');
                    
                    const response = await fetch(`${BACKEND_URL}/api/withdrawals`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ amount, walletAddress: walletAddressDetails }) 
                    });

                    const data = await response.json();


                    if (response.ok) {
                        animateButton(button, 'success');
                        showSuccessModal('Withdraw');
                        
                        // Atualiza o saldo local e o DOM
                        currentAvailableBalance -= amount;
                        document.getElementById('mainBalance').textContent = `${currentAvailableBalance.toFixed(2)} MT`;
                        form.reset(); 
                    } else if (response.status === 401 || response.status === 403) {
                        throw new Error("sessionExpired");
                    } else {
                        throw new Error(data.message || translations[currentLang].requestFailed);
                    }

                } catch (error) {
                    animateButton(button, 'error');
                    if (error.message.includes("sessionExpired")) {
                        showToast(translations[currentLang].sessionExpired, 'error');
                        localStorage.removeItem('token');
                        setTimeout(() => navigateTo('login.html'), 1500);
                    } else {
                        setInlineError('withdrawError', `${translations[currentLang].requestFailed} ${error.message}`);
                    }
                } finally {
                    // O botão volta ao normal dentro de animateButton(button, 'error') ou 'success'
                }
            }
        })(); 
    </script>
</body>
</html>